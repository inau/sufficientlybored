{% extends "layouts/default.html" %}

{% block content %}
<!-- The Modal -->
<div id="filter_modal" class="backdrop modal-hide col-xs-12 row">

	<!-- Modal content -->
	<div class="col-xs-1 col-md-4"></div>
	<div class="mContent modal-content col-xs-10 col-md-4">
		<div>
			<span onclick="modal_hide('filter_modal');" class="close">&times;</span>
		</div>
		<br>
		<br>
		<form id="cbroot">
			<div class="input-group row col-xs-12">
				{% for cat in data.categories %}
				<div class="col-md-4 col-xs-6">
					<label class="checkbox-inline">
						<input class="cbid " type="checkbox" value="{{cat._id}}"
							   {% if meta[cat._id].checked %}
							   checked
							   {% endif %}
							   name="{{cat.name}}">{{cat.name}}
					</label>
				</div>
				{% endfor %}
			</div>
		</form>
		<br>
		<form id="filter-form">
			<input type="hidden" value="{{getMeta}}" id="meta-data">
			<button class="btn btn-success col-xs-12" onclick="return apply_click('meta-data')">Apply</button>
		</form>
	</div>

</div>

<script src="../../js/image/component.js"></script>

<div class="container-fluid">
	<div class="jumbotron mJumbotron mContent col-xs-12">
	{% if user.canAccessKeystone %}
		{% if not data.validationErrors %}
		{% if data.project %}
			{% if data.project.sections.length > 0 %}
				<h2 class="ds">Existing sections:</h2>
				{% for sec in data.project.sections %}
					<div class="col-xs-12">
						<div class="col-xs-11 ds"> {{ sec.description }} </div>
						<image class="col-xs-1" src="data:image/jpeg;base64,{{sec.image}}" onerror="this.src='/images/proj_err.png';this.onerror=null;"></image>
					</div>
				{% endfor %}
			{% else %}
			<h2 class="ds">Add a section:</h2>
			{% endif %}
		
		<form id="sec-form" class="col-xs-12" method="post">
			<div class="input-group">
				<span class="input-group-addon"><i class="glyphicon glyphicon-align-center"></i></span>
				<textarea class="form-control" style="resize: none" rows="8" name="description" value="{{formData.description}}" placeholder="description"></textarea>
			</div>
			<div class="input-group mJumbob col-xs-12">
				<div id="imgph" class="col-xs-12" ></div>
				<div id="imgpreview" class="col-xs-12" ></div>
			</div>
				<input type="hidden" name="pid" value="{{ data.pid }}">
				<input type="hidden" name="action" value="section.create">
				<div class="input-group col-xs-12">
					<span class="input-group-addon btn btn-danger" ><i id="img_reset_btn" onclick="return imageclear();" class="glyphicon glyphicon-remove hidden"></i></span>
					<input class="form-control" id="img_select" type="file" accept="image/*" onchange="return imagechange();" >
					<span class="input-group-addon btn btn-success" onclick="$('#sec-form').submit()"><i class="glyphicon glyphicon-plus"></i></span>
				</div>

		</form>
		{% else %}
		<h2 class="ds">Create a new project:</h2>
		<form id="proj-form" class="col-xs-12" method="post">
			<div class="col-md-12 col-xs-12">
				<div class="input-group">
					<span class="input-group-addon">Start date</span>
					<input id="from" type="date" class="form-control" name="from" value="{{formData.from}}">
					<span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
				</div>
				<div class="input-group">
				<span class="input-group-addon"> End date </span>
				<input id="to" type="date" class="form-control" name="to" value="{{formData.from}}">
				<span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
			</div>
				<br>
				<div class="input-group">
					<span class="input-group-addon"><i class="glyphicon glyphicon-tags"></i></span>
					<input disabled id="cats_label" type="text" class="form-control" name="cats" value="{{formData.cats}}" onchange="function(){console.log('input change');};" placeholder="Chose Categories">
					<span class="input-group-addon btn btn-success" onclick="modal_show('filter_modal');" class="input-group-addon"><i class="glyphicon glyphicon-edit"></i></span>
				</div>
				<br>
				{% for cat in data.categories %}
				<span class="label label-default">{{ meta[cat].label }}</span>
				{% endfor %}
				<div class="input-group col-xs-12">
					<span class="input-group-addon"><i class="glyphicon glyphicon-tag"></i></span>
					<input id="title" type="text" class="form-control" name="title" value="{{formData.title}}" placeholder="Project Title">
					<span class="input-group-addon btn btn-success" onclick="$('#proj-form').submit()"><i class="glyphicon glyphicon-plus"></i></span>
				</div>
				<input type="hidden" name="action" value="project.create">
			</div>
		</form>
		{% endif %}
		
			
		{% else %}
		{{ data.validationErrors }}
		{% endif %}
	{% else %}
	<a href="/">You require admin access to be able to edit content...</a>
	{% endif %}
</div>
</div>

<script type="text/javascript">
//	$('.cho-sel').chosen({});
	
	function imageedit(img_id) {

	}
	function savetoform() {
		
		var $ph = $('.mdata');

		$ph.forEach( function (item) {
			console.log( item.name );
		} );
//		for( _img in  ) {
//			console.log( _img.src );	
//		}

		return false;
	}

	function imageclear() {
		$('#img_reset_btn').addClass('hidden');
		$('#fimg_id').removeClass('hidden');

		var placeholder = document.getElementById('imgph'), placeholder2 = document.getElementById('imgpreview');
		while( placeholder.firstChild || placeholder2.firstChild ) {
			if( placeholder.firstChild ) placeholder.removeChild( placeholder.firstChild );
			if( placeholder2.firstChild ) placeholder2.removeChild( placeholder2.firstChild );
		}
		$('#img_select').values = '';

		return false;
	}
	function imagechange() {
		$('#fimg_id').addClass('hidden');

		var imgs = document.getElementById('img_select');

		var nm = [];
		for (var i = 0; i < imgs.files.length; i++) {
			nm[i] = (i+1)+') '+imgs.files[i].name+'\n'
			if(i > 4 ) break;
		}

		var limit = imgs.files.length;
		
		if( limit > 4){
			alert('Limit is 4 files, some elements will be ignored:\n ' + nm);
			limit = 4;
		}
		
			for (var i = 0; i < limit; i++) {
				imageManipulator('imgph', imgs.files[i], i);
			}

		//prepare image reset button
		$('#img_reset_btn').removeClass('hidden');
		return false;
	};
	
	function apply_click(meta_id) {
			var meta =  $('#'+meta_id).attr('value');
			console.log('raw ' + meta);
			var jmeta = JSON.parse( meta );
			console.log('pos ' + jmeta);
			return getCheckboxList('cbid', function(r){
				var $inp = $('<input>');
				$inp.attr({
					type: 'hidden',
					name: 'cats',
					value: r
				});
				$('#filter-form').append($inp);
				
				var lbl = [];
				console.log('result ' + JSON.stringify(r));
				
				for(var i = 0; i < r.length; i++ ) {
					console.log('key ' + r[i]);
					lbl.push( jmeta[ r[i] ].label );
				}
				console.log(lbl);
				$('#cats_label').attr('value', lbl);
				
				modal_hide('filter_modal');

				return false;
			});
	};

</script>
{% endblock %}
